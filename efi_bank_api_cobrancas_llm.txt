# EFI Bank - Billing API (API Cobran√ßas) - LLM Documentation

> **Purpose**: Structured documentation of EFI Bank's Billing API (formerly Gerencianet) for future implementation. This documentation focuses especially on **Payment Links** and notification systems.
> 
> **Collection Date**: January 17, 2026
> 
> **Source**: https://dev.efipay.com.br/docs/api-cobrancas/

---

## üìã Table of Contents

1. [Overview](#overview)
2. [Credentials and Authentication](#credentials-and-authentication)
3. [Payment Link - Endpoints](#payment-link---endpoints)
4. [Transaction Status](#transaction-status)
5. [Notification System (Webhooks)](#notification-system-webhooks)
6. [Integration Examples](#integration-examples)
7. [Best Practices](#best-practices)

---

## Overview

The **EFI Billing API** offers advanced resources to issue different types of charges:
- Bank slip (boleto)
- Credit card
- Installment plan (carn√™)
- **Payment links** (focus of this documentation)
- Subscriptions (recurring charges)
- Marketplace (payment splitting)
- **PIX** (integrated in links)

### Payment Link Features

The **Payment Link** resource allows:
- Generate a link to Ef√≠'s hosted payment page
- Choose allowed payment methods (bank slip, card, PIX)
- No need to implement your own checkout
- Provides security to the payer with Ef√≠'s domain

### Advantages over Transparent Checkout

- **Simplicity**: No need to develop your own interface
- **Security**: Trusted Ef√≠ interface
- **Flexibility**: Choose payment methods
- **Maintenance**: Updates managed by Ef√≠

---

## Credentials and Authentication

### Obtaining Credentials

To integrate with the API, you need an **EFI Digital Account** and create an application.

**Process**:
1. Access your Ef√≠ account
2. Click on "API" in the side menu
3. Click on "Create application"
4. Enable the "Billing API"
5. Choose the scope (Production/Sandbox)

### Key Pairs

Each application has **2 key pairs**:
- `Client_Id` and `Client_Secret` for **Production**
- `Client_Id` and `Client_Secret` for **Sandbox (Homologation)**

### Base URLs (Routes)

| Environment | Base URL |
|-------------|----------|
| **Production** | `https://cobrancas.api.efipay.com.br` |
| **Sandbox** | `https://cobrancas-h.api.efipay.com.br` |

### OAuth2 Authentication

The API uses the **OAuth2** protocol with **HTTP Basic Auth** authentication.

**Authorization Endpoint**:
```
POST /v1/authorize
```

**Example Request (PHP)**:
```php
$config = [
    "client_id" => "YOUR-CLIENT-ID",
    "client_secret" => "YOUR-CLIENT-SECRET"
];

$autorizacao = base64_encode($config["client_id"] . ":" . $config["client_secret"]);

$curl = curl_init();
curl_setopt_array($curl, array(
    CURLOPT_URL => 'https://cobrancas-h.api.efipay.com.br/v1/authorize',
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_CUSTOMREQUEST => 'POST',
    CURLOPT_POSTFIELDS => '{"grant_type": "client_credentials"}',
    CURLOPT_HTTPHEADER => array(
        "Authorization: Basic $autorizacao",
        "Content-Type: application/json"
    ),
));

$response = curl_exec($curl);
curl_close($curl);
```

**Example Response**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 600,
  "expire_at": "1690986856033",
  "token_type": "Bearer"
}
```

### Token Attributes

| Attribute | Description | Type |
|-----------|-------------|------|
| `access_token` | Authorization token to use in requests | string |
| `refresh_token` | Token to renew an expired access_token | string |
| `expires_in` | Expiration time in seconds (default: 600) | integer |
| `expire_at` | ISO 8601 timestamp of expiration | string |
| `token_type` | Authorization type (always "Bearer") | string |

### Security

‚ö†Ô∏è **IMPORTANT**: 
- Implement two-factor authentication
- Store credentials securely (environment variables)
- Don't expose Client_Secret in frontend
- Use HTTPS in all communications

---

## Link de Pagamento - Endpoints

### Abordagens: One Step vs Two Steps

A API oferece duas abordagens para criar links de pagamento:

#### **One Step** (Recomendado para simplicidade)
- Cria transa√ß√£o e link em uma √∫nica requisi√ß√£o
- Retorna diretamente o `payment_url`
- Status inicial: `link`

#### **Two Steps** (Mais controle)
1. Criar a transa√ß√£o (`POST /v1/charge`) ‚Üí recebe `charge_id`, status: `new`
2. Associar ao link (`POST /v1/charge/:id/link`) ‚Üí recebe `payment_url`, status: `link`

---

### 1. Criar Link de Pagamento (One Step)

**Endpoint**:
```
POST /v1/charge/one-step/link
```

**Descri√ß√£o**: Cria transa√ß√£o e link de pagamento em uma √∫nica requisi√ß√£o.

**Headers**:
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**Body (estrutura m√≠nima)**:
```json
{
  "items": [
    {
      "name": "Produto ou Servi√ßo",
      "value": 10000,
      "amount": 1
    }
  ],
  "settings": {
    "payment_method": "all",
    "expire_at": "2026-12-31"
  },
  "metadata": {
    "notification_url": "https://seusite.com.br/webhook",
    "custom_id": "pedido_12345"
  }
}
```

**Campos Importantes**:

| Campo | Tipo | Descri√ß√£o | Obrigat√≥rio |
|-------|------|-----------|-------------|
| `items` | array | Itens da cobran√ßa | ‚úÖ Sim |
| `items[].name` | string | Nome do produto/servi√ßo | ‚úÖ Sim |
| `items[].value` | integer | Valor em centavos (ex: 10000 = R$ 100,00) | ‚úÖ Sim |
| `items[].amount` | integer | Quantidade | ‚úÖ Sim |
| `settings.payment_method` | string | Formas permitidas: "all", "banking_billet", "credit_card", "pix" | ‚úÖ Sim |
| `settings.expire_at` | string | Data de expira√ß√£o do link (YYYY-MM-DD) | ‚ùå N√£o |
| `metadata.notification_url` | string | URL para receber webhooks | ‚ùå N√£o |
| `metadata.custom_id` | string | Identificador customizado | ‚ùå N√£o |

**Response (200 OK)**:
```json
{
  "code": 200,
  "data": {
    "charge_id": 12345678,
    "total": 10000,
    "status": "link",
    "payment_url": "https://pagamento.efipay.com.br/v1/8a7sd89a7sd8",
    "created_at": "2026-01-17 10:30:00"
  }
}
```

---

### 2. Criar Transa√ß√£o (Two Steps - Passo 1)

**Endpoint**:
```
POST /v1/charge
```

**Descri√ß√£o**: Cria uma transa√ß√£o sem associar a forma de pagamento.

**Body**:
```json
{
  "items": [
    {
      "name": "Consulta M√©dica",
      "value": 25000,
      "amount": 1
    }
  ],
  "metadata": {
    "notification_url": "https://budmed.com.br/webhook/efi",
    "custom_id": "appointment_789"
  }
}
```

**Response**:
```json
{
  "code": 200,
  "data": {
    "charge_id": 87654321,
    "total": 25000,
    "status": "new",
    "created_at": "2026-01-17 10:35:00"
  }
}
```

---

### 3. Associar ao Link (Two Steps - Passo 2)

**Endpoint**:
```
POST /v1/charge/:id/link
```

**Descri√ß√£o**: Associa uma transa√ß√£o existente a um link de pagamento.

**URL Params**:
- `:id` ‚Üí `charge_id` retornado no Passo 1

**Body**:
```json
{
  "payment_method": "all",
  "expire_at": "2026-12-31",
  "message": "Pagamento da consulta m√©dica"
}
```

**Campos Adicionais**:

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `billet_discount` | integer | Desconto para boleto (centavos) |
| `card_discount` | integer | Desconto para cart√£o (centavos) |
| `message` | string | Mensagem ao pagador (at√© 80 caracteres) |
| `request_delivery_address` | boolean | Solicitar endere√ßo de entrega |

**Response**:
```json
{
  "code": 200,
  "data": {
    "charge_id": 87654321,
    "payment_url": "https://pagamento.efipay.com.br/v1/xyz123abc",
    "expire_at": "2026-12-31"
  }
}
```

---

### 4. Consultar Link de Pagamento

**Endpoint**:
```
GET /v1/charge/:id
```

**Descri√ß√£o**: Retorna informa√ß√µes detalhadas de uma transa√ß√£o/link.

**Response**:
```json
{
  "code": 200,
  "data": {
    "charge_id": 87654321,
    "total": 25000,
    "status": "link",
    "payment_url": "https://pagamento.efipay.com.br/v1/xyz123abc",
    "items": [...],
    "payment": null,
    "history": [...]
  }
}
```

---

### 5. Atualizar Metadata (notification_url / custom_id)

**Endpoint**:
```
PUT /v1/charge/:id/metadata
```

**Descri√ß√£o**: Atualiza URL de notifica√ß√£o ou custom_id de transa√ß√£o existente.

**Casos de Uso**:
- Altera√ß√£o de IP do servidor
- Instala√ß√£o de SSL (http ‚Üí https)
- Atualiza√ß√£o de webhook em lote
- Adicionar custom_id esquecido

**Body**:
```json
{
  "notification_url": "https://novo-servidor.com.br/webhook",
  "custom_id": "novo_id_interno"
}
```

**Limite**: 7.500 requisi√ß√µes a cada 24 horas neste endpoint.

---

### 6. Atualizar Par√¢metros do Link

**Endpoint**:
```
PUT /v1/charge/:id/link
```

**Descri√ß√£o**: Altera configura√ß√µes do link **antes** da confirma√ß√£o do pagamento.

**Par√¢metros Atualiz√°veis**:
- Formas de pagamento permitidas
- Descontos de boleto/cart√£o
- Descontos condicionais
- Mensagem ao cliente
- Data de vencimento
- Solicita√ß√£o de endere√ßo de entrega

**Body (exemplo)**:
```json
{
  "billet_discount": 500,
  "card_discount": 300,
  "message": "Pague com desconto at√© 31/12/2026",
  "expire_at": "2026-12-31"
}
```

---

### 7. Cancelar Link de Pagamento

**Endpoint**:
```
PUT /v1/charge/:id/cancel
```

**Descri√ß√£o**: Cancela uma transa√ß√£o/link de pagamento.

**Observa√ß√£o Importante**: 
- Se o cliente imprimiu o boleto **antes** do cancelamento, ele pode pagar normalmente
- Neste caso, o status muda de `canceled` ‚Üí `paid` ap√≥s confirma√ß√£o

---

### 8. Adicionar ao Hist√≥rico

**Endpoint**:
```
POST /v1/charge/:id/history
```

**Descri√ß√£o**: Adiciona mensagem customizada ao hist√≥rico da transa√ß√£o.

**Body**:
```json
{
  "description": "Cliente solicitou mudan√ßa de endere√ßo"
}
```

**Limites**:
- M√≠nimo: 1 caractere
- M√°ximo: 255 caracteres

---

### 9. Reenviar Link por Email

**Endpoint**:
```
POST /v1/charge/:id/link/resend
```

**Descri√ß√£o**: Reenvia o link de pagamento para um email.

**Body**:
```json
{
  "email": "cliente@email.com.br"
}
```

**Requisitos**:
- Transa√ß√£o deve ter `status = "link"`
- Email deve ser v√°lido

---

## Status das Transa√ß√µes

### Fluxo de Status - Transa√ß√µes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   new   ‚îÇ  Cobran√ßa criada, aguardando pagamento
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ‚îÄ‚ñ∫ link        Link de pagamento gerado
     ‚îÇ
     ‚îî‚îÄ‚îÄ‚ñ∫ waiting     Forma de pagamento selecionada
          ‚îÇ
          ‚îú‚îÄ‚îÄ‚ñ∫ identified   Pagamento identificado (antes do cr√©dito)
          ‚îÇ
          ‚îú‚îÄ‚îÄ‚ñ∫ approved     Pagamento aprovado (cart√£o)
          ‚îÇ
          ‚îî‚îÄ‚îÄ‚ñ∫ paid         ‚úÖ Pagamento confirmado
               ‚îÇ
               ‚îú‚îÄ‚îÄ‚ñ∫ refunded      Devolvido
               ‚îú‚îÄ‚îÄ‚ñ∫ contested     Contestado
               ‚îú‚îÄ‚îÄ‚ñ∫ canceled      Cancelado
               ‚îî‚îÄ‚îÄ‚ñ∫ settled       Confirmado manualmente
```

### Tabela Completa de Status

| Status | Descri√ß√£o | Status Final? |
|--------|-----------|---------------|
| `new` | Cobran√ßa gerada, aguardando forma de pagamento | ‚ùå |
| `link` | Link de pagamento ativo | ‚ùå |
| `waiting` | Forma de pagamento selecionada, aguardando confirma√ß√£o | ‚ùå |
| `identified` | Pagamento identificado, antes do cr√©dito | ‚ùå |
| `approved` | Pagamento aprovado pela operadora (cart√£o) | ‚ùå |
| `paid` | **Pagamento confirmado** | ‚úÖ |
| `unpaid` | N√£o foi poss√≠vel confirmar o pagamento | ‚úÖ |
| `refunded` | Pagamento devolvido | ‚úÖ |
| `contested` | Pagamento em contesta√ß√£o | ‚úÖ |
| `canceled` | Cobran√ßa cancelada | ‚úÖ |
| `settled` | Confirmado manualmente | ‚úÖ |
| `expired` | Link/cobran√ßa expirado | ‚úÖ |

### Status de Links de Pagamento

| Status | Quando Ocorre |
|--------|---------------|
| `new` | Link criado, nenhuma a√ß√£o do pagador |
| `link` | Link ativo, aguardando pagamento |
| `expired` | Link atingiu data de `expire_at` |

### Status Finais ("Resolvidos")

Uma cobran√ßa √© considerada **resolvida** quando atinge um dos status finais:
- ‚úÖ `paid` (sucesso)
- ‚úÖ `contested`
- ‚úÖ `refunded`
- ‚úÖ `settled`
- ‚úÖ `canceled`

---

## Sistema de Notifica√ß√µes (Webhooks)

### Como Funciona

A Ef√≠ envia **notifica√ß√µes autom√°ticas** via HTTP POST sempre que o status de uma transa√ß√£o muda.

**Processo em 2 Etapas**:
1. **Ef√≠ ‚Üí Sua URL**: POST com `notification` token
2. **Voc√™ ‚Üí Ef√≠**: GET `/v1/notification/:token` para obter detalhes

### Configurar URL de Notifica√ß√£o

**Durante cria√ß√£o da transa√ß√£o**:
```json
{
  "items": [...],
  "metadata": {
    "notification_url": "https://seusite.com.br/webhook/efi"
  }
}
```

**Atualizar posteriormente**:
```
PUT /v1/charge/:id/metadata
```

### Receber Notifica√ß√£o (Webhook)

**Request da Ef√≠ para sua URL**:
```
POST https://seusite.com.br/webhook/efi
Content-Type: application/x-www-form-urlencoded

notification=09027955-5e06-4ff0-a9c7-46b47b8f1b27
```

**Seu endpoint deve**:
1. Responder com status HTTP `200 OK`
2. Extrair o token: `$_POST['notification']`
3. Consultar detalhes: `GET /v1/notification/:token`

### Consultar Detalhes da Notifica√ß√£o

**Endpoint**:
```
GET /v1/notification/:token
```

**Exemplo (PHP)**:
```php
$token = $_POST["notification"];

$params = ['token' => $token];
$api = new Ef√≠($options);
$chargeNotification = $api->getNotification($params, []);

// Pegar √∫ltimo status
$i = count($chargeNotification["data"]);
$ultimoStatus = $chargeNotification["data"][$i-1];

$charge_id = $ultimoStatus["identifiers"]["charge_id"];
$statusAtual = $ultimoStatus["status"]["current"];
```

**Response (exemplo)**:
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "created_at": "2022-02-20 09:12:23",
      "type": "charge",
      "custom_id": null,
      "identifiers": {
        "charge_id": 24342333
      },
      "status": {
        "current": "new",
        "previous": null
      }
    },
    {
      "id": 2,
      "created_at": "2022-02-20 09:12:23",
      "type": "charge",
      "identifiers": {
        "charge_id": 24342333
      },
      "status": {
        "current": "waiting",
        "previous": "new"
      }
    },
    {
      "id": 3,
      "created_at": "2022-04-03 07:33:30",
      "type": "charge",
      "identifiers": {
        "charge_id": 24342333
      },
      "received_by_bank_at": "2022-04-02",
      "status": {
        "current": "paid",
        "previous": "unpaid"
      },
      "value": 6990
    }
  ]
}
```

### Estrutura da Resposta de Notifica√ß√£o

| Campo | Descri√ß√£o |
|-------|-----------|
| `id` | Ordem sequencial de eventos (1, 2, 3...) |
| `created_at` | Data/hora da altera√ß√£o |
| `type` | Tipo da cobran√ßa ("charge", "subscription", "carnet") |
| `custom_id` | Seu identificador customizado |
| `identifiers.charge_id` | ID √∫nico da transa√ß√£o |
| `status.current` | Status atual |
| `status.previous` | Status anterior |
| `value` | Valor confirmado (aparece quando `paid`) |
| `received_by_bank_at` | Data de recebimento (quando `paid`) |

### Ordem das Notifica√ß√µes

‚ö†Ô∏è **IMPORTANTE**: As notifica√ß√µes seguem a ordem cronol√≥gica dos eventos.

**Exemplo - Parcelamento (Carn√™)**:
- Parcela 1 paga ‚Üí notifica√ß√£o com `id: 1`
- Parcela 2 paga ‚Üí notifica√ß√£o com `id: 2`
- Parcela 3 paga ‚Üí notifica√ß√£o com `id: 3`

Para sincronizar: percorra o array e processe eventos n√£o sincronizados (n√£o assuma que o √∫ltimo √© sempre o novo).

### Tentativas de Reenvio

Se sua URL **n√£o responder com HTTP 200**, a Ef√≠ tenta reenviar:

| Tentativa | Tempo (minutos) |
|-----------|-----------------|
| 1 | 5 |
| 2 | 10 |
| 3 | 20 |
| 4 | 40 |
| 5 | 80 |
| 6 | 160 |
| 7 | 320 |
| 8 | 640 |
| 9 | 1.280 |
| 10 | 52.560 (‚âà36 dias) |

**Total**: At√© **3 dias de tentativas** desde o primeiro envio.

### Hist√≥rico de Notifica√ß√µes

Voc√™ pode visualizar:
- **Hist√≥rico de Notifica√ß√µes**: POSTs enviados pela Ef√≠
- **Hist√≥rico de Requisi√ß√µes**: GETs feitos pelo seu sistema

Acesse na interface Ef√≠: `API > Transa√ß√µes > [Transa√ß√£o] > Notifica√ß√µes`

### C√≥digos de Status HTTP

| C√≥digo | Significado |
|--------|-------------|
| `200` | ‚úÖ Sucesso |
| `301` | ‚ö†Ô∏è Redirecionamento permanente |
| `302` | ‚ö†Ô∏è Redirecionamento tempor√°rio |
| `404` | ‚ùå URL n√£o encontrada |
| `429` | ‚ö†Ô∏è Too many requests |
| `500` | ‚ùå Erro interno do servidor (seu) |

### Endere√ßos IP da Ef√≠

Para configurar firewall/whitelist, libere os IPs da Ef√≠:
üëâ https://sejaefi.com.br/central-de-ajuda/api/quais-enderecos-de-ip-gerencianet-utiliza

### Ferramenta de Teste: WebhookInbox

Para testar webhooks localmente sem servidor p√∫blico:
- Acesse: http://webhookinbox.com/
- Clique em "Create An Inbox"
- Use a URL gerada em `notification_url`
- Visualize POSTs enviados pela Ef√≠

---

## Exemplos de Integra√ß√£o

### Caso de Uso: Sistema de Agendamento M√©dico (BudMed)

**Cen√°rio**: Paciente agenda consulta e precisa pagar via link.

#### Passo 1: Criar Link de Pagamento

```php
// Ap√≥s paciente agendar consulta
$appointment = Appointment::find($appointmentId);

$items = [
    [
        'name' => 'Consulta - Dr. ' . $appointment->doctor->name,
        'value' => 25000, // R$ 250,00
        'amount' => 1
    ]
];

$metadata = [
    'notification_url' => 'https://budmed.com.br/webhook/efi',
    'custom_id' => 'appointment_' . $appointment->id
];

$body = [
    'items' => $items,
    'metadata' => $metadata,
    'settings' => [
        'payment_method' => 'all', // boleto, cart√£o, pix
        'expire_at' => now()->addDays(3)->format('Y-m-d'),
        'message' => 'Pagamento da consulta m√©dica'
    ]
];

// Enviar para Ef√≠
$response = $efiApi->createOneStepLink($body);

// Salvar na base de dados
$appointment->update([
    'charge_id' => $response['data']['charge_id'],
    'payment_url' => $response['data']['payment_url'],
    'payment_status' => 'pending'
]);

// Enviar link para paciente (email/SMS)
$this->sendPaymentLink($appointment->patient, $response['data']['payment_url']);
```

#### Passo 2: Receber Webhook

```php
// routes/web.php
Route::post('/webhook/efi', [EfiWebhookController::class, 'handle']);

// EfiWebhookController.php
public function handle(Request $request)
{
    $token = $request->input('notification');
    
    // Consultar detalhes na Ef√≠
    $params = ['token' => $token];
    $details = $this->efiApi->getNotification($params);
    
    // Pegar √∫ltimo status
    $lastEvent = end($details['data']);
    $chargeId = $lastEvent['identifiers']['charge_id'];
    $status = $lastEvent['status']['current'];
    
    // Buscar consulta pelo charge_id
    $appointment = Appointment::where('charge_id', $chargeId)->first();
    
    if (!$appointment) {
        Log::error('Appointment not found for charge_id: ' . $chargeId);
        return response()->json(['status' => 'error'], 404);
    }
    
    // Atualizar status conforme webhook
    switch ($status) {
        case 'paid':
            $appointment->update(['payment_status' => 'paid']);
            event(new AppointmentPaid($appointment));
            break;
            
        case 'waiting':
            $appointment->update(['payment_status' => 'processing']);
            break;
            
        case 'canceled':
            $appointment->update(['payment_status' => 'canceled']);
            event(new AppointmentCanceled($appointment));
            break;
            
        case 'refunded':
            $appointment->update(['payment_status' => 'refunded']);
            break;
    }
    
    // SEMPRE retornar 200 OK
    return response()->json(['status' => 'success'], 200);
}
```

#### Passo 3: L√≥gica de Neg√≥cio

```php
// AppointmentPaid Event Listener
class SendAppointmentConfirmation
{
    public function handle(AppointmentPaid $event)
    {
        $appointment = $event->appointment;
        
        // 1. Enviar confirma√ß√£o por email
        Mail::to($appointment->patient->email)
            ->send(new AppointmentConfirmedMail($appointment));
        
        // 2. Notificar m√©dico
        $appointment->doctor->notify(
            new NewAppointmentNotification($appointment)
        );
        
        // 3. Gerar link do Google Meet (se configurado)
        if ($appointment->is_online) {
            $meetLink = $this->googleMeetService->createMeeting($appointment);
            $appointment->update(['meet_link' => $meetLink]);
        }
    }
}
```

---

### Caso de Uso: Produtos de Prescri√ß√£o

**Cen√°rio**: Paciente precisa comprar produtos recomendados pelo m√©dico.

```php
// Criar link para compra de produtos
$prescription = Prescription::find($prescriptionId);
$items = [];

foreach ($prescription->products as $product) {
    $items[] = [
        'name' => $product->name,
        'value' => $product->pivot->recommended_quantity * $product->price,
        'amount' => $product->pivot->recommended_quantity
    ];
}

$body = [
    'items' => $items,
    'metadata' => [
        'notification_url' => 'https://budmed.com.br/webhook/efi',
        'custom_id' => 'prescription_' . $prescription->id
    ],
    'settings' => [
        'payment_method' => 'all',
        'request_delivery_address' => true, // Solicitar endere√ßo de entrega
        'message' => 'Produtos da sua prescri√ß√£o m√©dica'
    ]
];

$response = $efiApi->createOneStepLink($body);

Order::create([
    'prescription_id' => $prescription->id,
    'charge_id' => $response['data']['charge_id'],
    'payment_url' => $response['data']['payment_url'],
    'total_price' => $response['data']['total'],
    'status' => 'pending'
]);
```

---

## Boas Pr√°ticas

### ‚úÖ Seguran√ßa

1. **Proteja suas credenciais**:
   - Use vari√°veis de ambiente (`.env`)
   - NUNCA commite `Client_Secret` no git
   - Implemente autentica√ß√£o 2FA

2. **Valide Webhooks**:
   - Sempre consulte `GET /v1/notification/:token`
   - N√£o confie apenas no POST recebido
   - Implemente logging de todas as notifica√ß√µes

3. **HTTPS Obrigat√≥rio**:
   - Use SSL em produ√ß√£o
   - Mantenha certificados atualizados
   - Configure redirects corretamente (301/302)

### ‚úÖ Tratamento de Erros

1. **Sempre retorne HTTP 200** no webhook (mesmo com erro interno)
2. Implemente retry logic para chamadas √† API Ef√≠
3. Use try-catch em todas as intera√ß√µes com API
4. Mantenha logs detalhados de erros

### ‚úÖ Performance

1. **Webhook deve ser r√°pido**:
   - Receba POST ‚Üí valide ‚Üí responda 200 OK
   - Processe l√≥gica de neg√≥cio em background (jobs/queues)

2. **Cache de tokens**:
   - Tokens duram 600 segundos (10 min)
   - Reutilize tokens v√°lidos
   - Implemente refresh autom√°tico

3. **Rate Limiting**:
   - Endpoint `/charge/:id/metadata`: max 7.500 req/24h
   - Implemente controle de requisi√ß√µes

### ‚úÖ Monitoramento

1. **Verifique Status da Fila**:
   - Acesse: https://sejaefi.com.br/confirmacoes
   - Monitore atrasos em callbacks

2. **Hist√≥rico de Notifica√ß√µes**:
   - Interface Ef√≠ mostra POSTs enviados
   - Verifique falhas (404, 500, etc.)

3. **Testes com Postman**:
   - Collection oficial: https://documenter.getpostman.com/view/13574984/Uz5ArJQc
   - Configure environments (Produ√ß√£o/Homologa√ß√£o)

### ‚úÖ Desenvolvimento

1. **Use ambiente de Homologa√ß√£o** para testes
2. **WebhookInbox** para testar callbacks localmente
3. Implemente **feature flags** para ativar/desativar integra√ß√µes
4. Mantenha **documenta√ß√£o interna** atualizada

### ‚úÖ Gest√£o de Transa√ß√µes

1. **Sempre use `custom_id`**:
   - Facilita rastreamento
   - Evita duplica√ß√µes
   - Permite reconcilia√ß√£o

2. **Monitore status finais**:
   - `paid` ‚Üí processar pedido
   - `canceled` ‚Üí notificar usu√°rio
   - `refunded` ‚Üí reverter opera√ß√µes

3. **Hist√≥rico de transa√ß√µes**:
   - Use `POST /v1/charge/:id/history` para anota√ß√µes
   - Registre mudan√ßas importantes
   - Facilita suporte ao cliente

---

## Collection Postman

**Link Oficial**: https://documenter.getpostman.com/view/13574984/Uz5ArJQc

**Como usar**:
1. Importe a collection no Postman
2. Crie um Environment com:
   - `efi-cob-api`: URL base (prod/homolog)
   - `client_id`: Seu Client_Id
   - `client_secret`: Seu Client_Secret
3. Execute `/v1/authorize` primeiro
4. Token ser√° salvo automaticamente como vari√°vel
5. Teste outros endpoints

---

## Recursos Adicionais

### Documenta√ß√£o Oficial
- **Portal Dev**: https://dev.efipay.com.br/
- **FAQ**: https://sejaefi.com.br/central-de-ajuda
- **Comunidade**: https://comunidade.sejaefi.com.br
- **Status de Confirma√ß√µes**: https://sejaefi.com.br/confirmacoes

### SDKs Oficiais
A Ef√≠ oferece SDKs para:
- PHP
- Node.js
- Python
- .NET
- Ruby
- Java
- Go
- Delphi

### Suporte
- **Telefone SP**: (11) 2394 2208
- **Telefone Nacional**: 0800 941 2343
- **Ouvidoria**: 0800 940 0361
- **Endere√ßo**: Av Paulista, 1337 - Bela Vista, S√£o Paulo, SP

---

## Pr√≥ximos Passos para Implementa√ß√£o

### Fase 1: Prepara√ß√£o
- [ ] Criar conta Ef√≠ (Produ√ß√£o + Homologa√ß√£o)
- [ ] Gerar credenciais (`Client_Id` e `Client_Secret`)
- [ ] Configurar vari√°veis de ambiente
- [ ] Instalar SDK oficial (ou criar HTTP client)

### Fase 2: Desenvolvimento
- [ ] Implementar autentica√ß√£o OAuth2
- [ ] Criar servi√ßo de gera√ß√£o de links (`PaymentLinkService`)
- [ ] Implementar webhook endpoint (`/webhook/efi`)
- [ ] Criar tratamento de status (`paid`, `canceled`, etc.)
- [ ] Integrar com sistema de notifica√ß√µes

### Fase 3: Testes
- [ ] Testar cria√ß√£o de links em homologa√ß√£o
- [ ] Validar recebimento de webhooks (usar WebhookInbox)
- [ ] Simular pagamentos (ambiente sandbox)
- [ ] Testar fluxo completo (criar ‚Üí pagar ‚Üí confirmar)

### Fase 4: Produ√ß√£o
- [ ] Migrar credenciais para produ√ß√£o
- [ ] Configurar SSL no webhook endpoint
- [ ] Liberar IPs da Ef√≠ no firewall
- [ ] Ativar monitoring de webhooks
- [ ] Documentar processo de suporte

---

## Changelog desta Documenta√ß√£o

| Vers√£o | Data | Altera√ß√µes |
|--------|------|------------|
| 1.0.0 | 2026-01-17 | Documenta√ß√£o inicial - foco em Links de Pagamento |

---

## Notas Finais

Esta documenta√ß√£o foi criada para **planejamento de integra√ß√£o futura**. N√£o cont√©m c√≥digo de produ√ß√£o implementado, apenas estrutura de endpoints e exemplos conceituais.

**Antes de implementar**:
1. Valide requisitos de neg√≥cio
2. Defina arquitetura de integra√ß√£o
3. Configure ambiente de testes
4. Implemente testes automatizados
5. Planeje rollout gradual

**Considera√ß√µes Especiais para BudMed**:
- Integrar com sistema de Orders existente
- Mapear status Ef√≠ ‚Üí status interno
- Sincronizar com Google Meet (appointments online)
- Notificar pacientes via sistema existente
- Considerar cupons de desconto (se aplic√°vel)

---

**Documenta√ß√£o coletada em**: 17 de Janeiro de 2026  
**Fonte**: https://dev.efipay.com.br/docs/api-cobrancas/  
**Autor**: GitHub Copilot Agent  
**Prop√≥sito**: LLM-friendly documentation para implementa√ß√£o futura
